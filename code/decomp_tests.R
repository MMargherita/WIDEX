source("code/ex_functions.R")

# 1: partnered    P
# 2: unpartnered  U
# 3: widowed      W
# 4: dead         D
library(readODS)
tmat1 <- read_ods("output/output_17_11_23/trans_mat/trans_mat_gen1_0204_mid.ods")
tmat2 <- read_ods("output/output_17_11_23/trans_mat/trans_mat_gen2_0204_mid.ods")
init1 <- c(P=.78,U=.18,W = .04)
init2 <- c(P=.61,U=.22,W = .16)
init1 <- init1 / sum(init1)
init2 <- init2 / sum(init2)
attrition_vec1 <-
  tmat1 |> 
  rename(age = rownames) |> 
  # TR: double check this age filter, might need one age higher?
  filter(between(age, 65, 111)) |> 
  pivot_longer(X_p11:X_p34, names_to = "transition", values_to = "p") |> 
  mutate(p = ifelse(is.na(p),0,p),
         transition = gsub("X_p","", transition),
         transition = gsub("1","P", transition),
         transition = gsub("2","U", transition),
         transition = gsub("3","W", transition),
         transition = gsub("4","D", transition),
         from = substr(transition,1,1),
         to = substr(transition,2,2)) |> 
  select(-transition) |> 
  p_tibble_to_attrition_vec()
attrition_vec2 <-
  tmat2 |> 
  rename(age = rownames) |> 
  # TR: double check this age filter, might need one age higher?
  filter(between(age, 65, 111)) |> 
  pivot_longer(X_p11:X_p34, names_to = "transition", values_to = "p") |> 
  mutate(p = ifelse(is.na(p),0,p),
         transition = gsub("X_p","", transition),
         transition = gsub("1","P", transition),
         transition = gsub("2","U", transition),
         transition = gsub("3","W", transition),
         transition = gsub("4","D", transition),
         from = substr(transition,1,1),
         to = substr(transition,2,2)) |> 
  select(-transition) |> 
  p_tibble_to_attrition_vec()

attrition_vec1 <- c(attrition_vec1, init1)
attrition_vec2 <- c(attrition_vec2, init2)

attrition_vec_to_ex(attrition_vec1, state = "W") -
attrition_vec_to_ex(attrition_vec2, state = "W")




library(tictoc)
tic()
cc <- horiuchi(attrition_vec_to_ex, attrition_vec1, attrition_vec2, N = 2, state = "W")
toc()

cc_init <- cc[nchar(names(cc)) == 1]
cc_transitions <- cc[nchar(names(cc))>1]

sum(cc_init) # wow
cc_transitions |> 
  attrition_vec_to_p_tibble() |> 
  ungroup() |> 
  filter(to != from) |> 
  rename(contribution = p) |> 
  summarize(contribution = sum(contribution),
            .by=c(from,to)) |> 
  arrange(contribution)

cc_transitions |> 
  attrition_vec_to_p_tibble() |> 
  filter(to != from) |> 
  rename(contribution = p) |> 
  ggplot(aes(x = age, y = contribution, color = interaction(from, to))) +
  geom_line() +
  theme_minimal()

cc<- c(P_U_65 = -0.000533131023420896, P_W_65 = 0.0930385371539204, 
       P_D_65 = 0.0343349964101867, U_P_65 = -0.00553611065960613, U_W_65 = 6.47429628828355e-05, 
       U_D_65 = 0.00143194494037546, W_P_65 = 0.0181151058229148, W_U_65 = 0.000140040317905932, 
       W_D_65 = 0.0870726298899447, P_U_66 = -0.000583169478423518, 
       P_W_66 = 0.0979454704576899, P_D_66 = 0.0342978734647681, U_P_66 = -0.005256053131931, 
       U_W_66 = 6.60416003710473e-05, U_D_66 = 0.00130421131725189, 
       W_P_66 = 0.016734745135417, W_U_66 = 0.000131678871094554, W_D_66 = 0.0841207332411358, 
       P_U_67 = -0.000638079485344889, P_W_67 = 0.102491483402912, P_D_67 = 0.0341437188430156, 
       U_P_67 = -0.00497224894782233, U_W_67 = 6.69161330488777e-05, 
       U_D_67 = 0.0011827622351408, W_P_67 = 0.0155142531139276, W_U_67 = 0.000124211917537753, 
       W_D_67 = 0.0816664108970819, P_U_68 = -0.00069661943202215, P_W_68 = 0.106598827236963, 
       P_D_68 = 0.0338578313496773, U_P_68 = -0.0046854692088405, U_W_68 = 6.72926235711913e-05, 
       U_D_68 = 0.00106769417080654, W_P_68 = 0.0144231546980822, W_U_68 = 0.000117463381900329, 
       W_D_68 = 0.0795976877352724, P_U_69 = -0.00075734942923944, P_W_69 = 0.110189135915959, 
       P_D_69 = 0.0334257417545376, U_P_69 = -0.00439658915652652, U_W_69 = 6.71887134569005e-05, 
       U_D_69 = 0.00095910015612688, W_P_69 = 0.0134366875250223, W_U_69 = 0.000111253154087443, 
       W_D_69 = 0.0778165065422822, P_U_70 = -0.000818704953624572, 
       P_W_70 = 0.113184819375327, P_D_70 = 0.0328340729459788, U_P_70 = -0.00410666295853446, 
       U_W_70 = 6.66017821324694e-05, U_D_70 = 0.000857062490899896, 
       W_P_70 = 0.0125347781430363, W_U_70 = 0.000105454642103098, W_D_70 = 0.0762358186300998, 
       P_U_71 = -0.000878889917395931, P_W_71 = 0.115510536905233, P_D_71 = 0.0320710443263068, 
       U_P_71 = -0.00381684500416357, U_W_71 = 6.54700397175745e-05, 
       U_D_71 = 0.000761644033741238, W_P_71 = 0.0117012280481181, W_U_71 = 9.99595796873365e-05, 
       W_D_71 = 0.0747773170613537, P_U_72 = -0.000935981212171644, 
       P_W_72 = 0.117095292589309, P_D_72 = 0.0311272495635122, U_P_72 = -0.0035284147372816, 
       U_W_72 = 6.38389314340237e-05, U_D_72 = 0.000672879751449695, 
       W_P_72 = 0.0109230346462899, W_U_72 = 9.46745180536723e-05, W_D_72 = 0.0733698706548873, 
       P_U_73 = -0.00098802383674057, P_W_73 = 0.117874072069871, P_D_73 = 0.0299964976948353, 
       U_P_73 = -0.00324277158224673, U_W_73 = 6.17765405661608e-05, 
       U_D_73 = 0.000590772318590282, W_P_73 = 0.0101898540444387, W_U_73 = 8.95354928931447e-05, 
       W_D_73 = 0.0719483933391332, P_U_74 = -0.00103299926135936, P_W_74 = 0.117790447272597, 
       P_D_74 = 0.0286766890576557, U_P_74 = -0.0029614293493605, U_W_74 = 5.92552928844192e-05, 
       U_D_74 = 0.000515284525510751, W_P_74 = 0.0094935012675359, W_U_74 = 8.44895309897176e-05, 
       W_D_74 = 0.0704533258808944, P_U_75 = -0.0010688749986536, P_W_75 = 0.116798927755096, 
       P_D_75 = 0.0271706639468534, U_P_75 = -0.00268596987560921, U_W_75 = 5.63217099434077e-05, 
       U_D_75 = 0.00044633522432358, W_P_75 = 0.00882769682813178, W_U_75 = 7.9475327509293e-05, 
       W_D_75 = 0.0688303623804463, P_U_76 = -0.00109381002339282, P_W_76 = 0.11486763418215, 
       P_D_76 = 0.0254870694910339, U_P_76 = -0.002418029171257, U_W_76 = 5.30608796704968e-05, 
       U_D_76 = 0.000383796699490624, W_P_76 = 0.00818764220916979, 
       W_U_76 = 7.44750057344312e-05, W_D_76 = 0.067030817093106, P_U_77 = -0.00110615156613392, 
       P_W_77 = 0.111981142991179, P_D_77 = 0.0236410689641384, U_P_77 = -0.00215927248473013, 
       U_W_77 = 4.94943499504963e-05, U_D_77 = 0.000327492185246747, 
       W_P_77 = 0.00756988671308045, W_U_77 = 6.94786197219521e-05, 
       W_D_77 = 0.065012044906025, P_U_78 = -0.00110457779118622, P_W_78 = 0.108143250587402, 
       P_D_78 = 0.0216547844080868, U_P_78 = -0.00191134463982268, U_W_78 = 4.56993336115374e-05, 
       U_D_78 = 0.000277196901194543, W_P_78 = 0.00697200973196566, 
       W_U_78 = 6.44832234226733e-05, W_D_78 = 0.062738518231527, P_U_79 = -0.00108815722785494, 
       P_W_79 = 0.103379827183165, P_D_79 = 0.0195575560398051, U_P_79 = -0.00167584036851576, 
       U_W_79 = 4.17396904555112e-05, U_D_79 = 0.000232640079027124, 
       W_P_79 = 0.00639261699172211, W_U_79 = 5.94579763331105e-05, 
       W_D_79 = 0.0601829166774683, P_U_80 = -0.0010564959572914, P_W_80 = 0.0977412471231336, 
       P_D_80 = 0.0173855754239436, U_P_80 = -0.00145423178760629, U_W_80 = 3.76933203529717e-05, 
       U_D_80 = 0.000193509006366277, W_P_80 = 0.00583103376187566, 
       W_U_80 = 5.44481435542643e-05, W_D_80 = 0.05732758814738, P_U_81 = -0.00100980438680276, 
       P_W_81 = 0.0913042720148858, P_D_81 = 0.0151811636449044, U_P_81 = -0.00124783647116677, 
       U_W_81 = 3.3624920510178e-05, U_D_81 = 0.000159454918751578, 
       W_P_81 = 0.00528734626812311, W_U_81 = 4.94696427106867e-05, 
       W_D_81 = 0.054165984336024, P_U_82 = -0.000948962745224602, P_W_82 = 0.084173443251133, 
       P_D_82 = 0.0129913175998602, U_P_82 = -0.00105775850213652, U_W_82 = 2.9626383677428e-05, 
       U_D_82 = 0.000130099935591765, W_P_82 = 0.00476219303847847, 
       W_U_82 = 4.45596914295798e-05, W_D_82 = 0.0507043810034236, P_U_83 = -0.000875529323138835, 
       P_W_83 = 0.0764810044296467, P_D_83 = 0.010865611236957, U_P_83 = -0.000884848822893414, 
       U_W_83 = 2.57516183870266e-05, U_D_83 = 0.000105045927141223, 
       W_P_83 = 0.00425677340850106, W_U_83 = 3.97138326722057e-05, 
       W_D_83 = 0.0469630373313077, P_U_84 = -0.000791766066591926, 
       P_W_84 = 0.0683855485692177, P_D_84 = 0.00885353186275051, U_P_84 = -0.000729647135618183, 
       U_W_84 = 2.20591175597029e-05, U_D_84 = 8.38830755092168e-05, 
       W_P_84 = 0.00377264303566038, W_U_84 = 3.50228481638126e-05, 
       W_D_84 = 0.0429772331301739, P_U_85 = -0.00070050995735782, P_W_85 = 0.060068524037828, 
       P_D_85 = 0.00700121472217541, U_P_85 = -0.000592363566310983, 
       U_W_85 = 1.86116753559951e-05, U_D_85 = 6.61995797694992e-05, 
       W_P_85 = 0.00331171866725821, W_U_85 = 3.05030525806771e-05, 
       W_D_85 = 0.0387976124343545, P_U_86 = -0.000605068276258169, 
       P_W_86 = 0.0517285486490899, P_D_86 = 0.00534801251215988, U_P_86 = -0.000472845242345254, 
       U_W_86 = 1.54405433558935e-05, U_D_86 = 5.15902279936142e-05, 
       W_P_86 = 0.00287614935182301, W_U_86 = 2.62014539882394e-05, 
       W_D_86 = 0.0344896514449169, P_U_87 = -0.000509012107085205, 
       P_W_87 = 0.0435730751688848, P_D_87 = 0.00392314195255095, U_P_87 = -0.000370584985830646, 
       U_W_87 = 1.25931594845419e-05, U_D_87 = 3.96641628745975e-05, 
       W_P_87 = 0.00246815166710013, W_U_87 = 2.21736367280734e-05, 
       W_D_87 = 0.0301320175505801, P_U_88 = -0.000415916371593994, 
       P_W_88 = 0.0358076035734256, P_D_88 = 0.00274292897564088, U_P_88 = -0.000284727783843586, 
       U_W_88 = 1.00766411534892e-05, U_D_88 = 3.00518001399297e-05, 
       W_P_88 = 0.00208994814060581, W_U_88 = 1.84472672368763e-05, 
       W_D_88 = 0.025813553765206, P_U_89 = -0.000329088004527467, P_W_89 = 0.0286227831408103, 
       P_D_89 = 0.00180914237225327, U_P_89 = -0.00021410958976098, 
       U_W_89 = 7.90718894627673e-06, U_D_89 = 2.2409297698367e-05, 
       W_P_89 = 0.00174359320419271, W_U_89 = 1.50569250307875e-05, 
       W_D_89 = 0.0216289798372755, P_U_90 = -0.000251281918755453, 
       P_W_90 = 0.0221804376807251, P_D_90 = 0.00110890551154119, U_P_90 = -0.000157307143961116, 
       U_W_90 = 6.07015440046155e-06, U_D_90 = 1.64224902419186e-05, 
       W_P_90 = 0.00143076474690229, W_U_90 = 1.20292364860219e-05, 
       W_D_90 = 0.0176731607027607, P_U_91 = -0.000184457002329719, 
       P_W_91 = 0.0166001372165541, P_D_91 = 0.000616396811970787, U_P_91 = -0.00011271150272707, 
       U_W_91 = 4.55589086634234e-06, U_D_91 = 1.18082675450992e-05, 
       W_P_91 = 0.00115267860490054, W_U_91 = 9.3873021467239e-06, W_D_91 = 0.014034470296195, 
       P_U_92 = -0.000129621510328803, P_W_92 = 0.0119483545941899, 
       P_D_92 = 0.000296303462281156, U_P_92 = -7.86060174342573e-05, 
       U_W_92 = 3.3366506775323e-06, U_D_92 = 8.31526421141149e-06, 
       W_P_92 = 0.000909880249752693, W_U_92 = 7.13382686745589e-06, 
       W_D_92 = 0.0107877039618889, P_U_93 = -8.67947785874179e-05, 
       P_W_93 = 0.00823260302473505, P_D_93 = 0.000108539624123605, 
       U_P_93 = -5.32520534957115e-05, U_W_93 = 2.38077198755349e-06, 
       U_D_93 = 5.72329479275879e-06, W_P_93 = 0.000702168456631735, 
       W_U_93 = 5.26434286296507e-06, W_D_93 = 0.00798742348900783, 
       P_U_94 = -5.51008858598045e-05, P_W_94 = 0.00540239808398857, 
       P_D_94 = 1.33904318304623e-05, U_P_94 = -3.49711816034493e-05, 
       U_W_94 = 1.65320257483614e-06, U_D_94 = 3.84215390880627e-06, 
       W_P_94 = 0.000528464039861287, W_U_94 = 3.75316647716062e-06, 
       W_D_94 = 0.00566283540665102, P_U_95 = -3.29862337706821e-05, 
       P_W_95 = 0.00335790813205161, P_D_95 = -2.39648868372022e-05, 
       U_P_95 = -2.22156663594042e-05, U_W_95 = 1.11559790783033e-06, 
       U_D_95 = 2.51023793085281e-06, W_P_95 = 0.000386861244906722, 
       W_U_95 = 2.57327667307905e-06, W_D_95 = 0.00381499576345101, 
       P_U_96 = -1.85166361235112e-05, P_W_96 = 0.0019654017383286, 
       P_D_96 = -3.0467114138677e-05, U_P_96 = -1.36225749014507e-05, 
       U_W_96 = 7.30166887841222e-07, U_D_96 = 1.59258176957167e-06, 
       W_P_96 = 0.000274648532533561, W_U_96 = 1.6888091671774e-06, 
       W_D_96 = 0.00241730282000896, P_U_97 = -9.69012490070753e-06, 
       P_W_97 = 0.00107673696603428, P_D_97 = -2.42139354216242e-05, 
       U_P_97 = -8.0462221072608e-06, U_W_97 = 4.63306786713247e-07, 
       U_D_97 = 9.79004437962061e-07, W_P_97 = 0.000188480958823956, 
       W_U_97 = 1.04923574673066e-06, W_D_97 = 0.00141941464830353, 
       P_U_98 = -4.70056345980296e-06, P_W_98 = 0.000548796160948495, 
       P_D_98 = -1.53735218164641e-05, U_P_98 = -4.56832666362317e-06, 
       U_W_98 = 2.84162794184084e-07, U_D_98 = 5.81912006580865e-07, 
       W_P_98 = 0.000124582961420927, W_U_98 = 6.13557653128538e-07, 
       W_D_98 = 0.00075419289488643, P_U_99 = -2.1023946983334e-06, 
       P_W_99 = 0.000258730186839085, P_D_99 = -8.29175431604767e-06, 
       U_P_99 = -2.48818912806925e-06, U_W_99 = 1.68654834986626e-07, 
       U_D_99 = 3.33784841988205e-07, W_P_99 = 7.89926417774645e-05, 
       W_U_99 = 3.3022763457069e-07, W_D_99 = 0.000346563306313996, 
       P_U_100 = -8.63199499434586e-07, P_W_100 = 0.000112263674850954, 
       P_D_100 = -3.88721043531604e-06, U_P_100 = -1.29754295574713e-06, 
       U_W_100 = 9.65454920454079e-08, U_D_100 = 1.84431374616878e-07, 
       W_P_100 = 4.78270885033716e-05, W_U_100 = 1.60172552998716e-07, 
       W_D_100 = 0.000122665046154768, P_U_101 = -3.24471256085701e-07, 
       P_W_101 = 4.46745119071501e-05, P_D_101 = -1.6013400530035e-06, 
       U_P_101 = -6.46644398472063e-07, U_W_101 = 5.33290673843112e-08, 
       U_D_101 = 9.80070087308604e-08, W_P_101 = 2.75104546738625e-05, 
       W_U_101 = 6.58008376674957e-08, W_D_101 = 1.75924436449648e-05, 
       P_U_102 = -1.11689871129528e-07, P_W_102 = 1.62899895235213e-05, 
       P_D_102 = -5.84215112731101e-07, U_P_102 = -3.0741946588364e-07, 
       U_W_102 = 2.84712511344765e-08, U_D_102 = 5.00109575973795e-08, 
       W_P_102 = 1.49475343129701e-05, W_U_102 = 1.92594775683119e-08, 
       W_D_102 = -1.96079503322899e-05, P_U_103 = -3.53758800031301e-08, 
       P_W_103 = 5.46082242447454e-06, P_D_103 = -1.90527153609565e-07, 
       U_P_103 = -1.39173812918614e-07, U_W_103 = 1.46167575820755e-08, 
       U_D_103 = 2.44690303574657e-08, W_P_103 = 7.62285685196318e-06, 
       W_U_103 = 8.62314664118458e-11, W_D_103 = -2.42882593273208e-05, 
       P_U_104 = -1.04233444098156e-08, P_W_104 = 1.69858460186134e-06, 
       P_D_104 = -5.63159288091697e-08, U_P_104 = -5.98926024331092e-08, 
       U_W_104 = 7.24330195822631e-09, U_D_104 = 1.14570775089362e-08, 
       W_P_104 = 3.62308476287154e-06, W_U_104 = -5.3025446256072e-09, 
       W_D_104 = -1.75862668521098e-05, P_U_105 = -2.90619084353239e-09, 
       P_W_105 = 4.9806670077146e-07, P_D_105 = -1.53753663134637e-08, 
       U_P_105 = -2.44548368222297e-08, U_W_105 = 3.4506322243999e-09, 
       U_D_105 = 5.12063547120079e-09, W_P_105 = 1.59254894516181e-06, 
       W_U_105 = -5.10722442115252e-09, W_D_105 = -9.80786007653833e-06, 
       P_U_106 = -7.81386955139851e-10, P_W_106 = 1.40383568325575e-07, 
       P_D_106 = -3.9562912945712e-09, U_P_106 = -9.45331857238330e-09, 
       U_W_106 = 1.58028212737804e-09, U_D_106 = 2.17331397323051e-09, 
       W_P_106 = 6.42005826279046e-07, W_U_106 = -3.37251782056569e-09, 
       W_D_106 = -4.44268095423084e-06, P_U_107 = -2.04861905217513e-10, 
       P_W_107 = 3.8604920593599e-08, P_D_107 = -9.70930891242006e-10, 
       U_P_107 = -3.44790196393774e-09, U_W_107 = 6.92956358960828e-10, 
       U_D_107 = 8.66015703593348e-10, W_P_107 = 2.35220891209309e-07, 
       W_U_107 = -1.80899251134292e-09, W_D_107 = -1.63224806248863e-06, 
       P_U_108 = -5.19748688532218e-11, P_W_108 = 1.03672945783728e-08, 
       P_D_108 = -2.25606200388029e-10, U_P_108 = -1.17702203539238e-09, 
       U_W_108 = 2.91885626779731e-10, U_D_108 = 3.14809067702981e-10, 
       W_P_108 = 7.75337918312857e-08, W_U_108 = -8.19878387403605e-10, 
       W_D_108 = -4.65542679073394e-07, P_U_109 = -1.2247092229245e-11, 
       P_W_109 = 2.67492916705692e-09, P_D_109 = -4.76325645593079e-11, 
       U_P_109 = -3.65411256808557e-10, U_W_109 = 1.16581411191419e-10, 
       U_D_109 = 9.63611412885257e-11, W_P_109 = 2.26800427327589e-08, 
       W_U_109 = -3.17518455972277e-10, W_D_109 = -8.84531745626305e-08, 
       P_U_110 = -2.28306262783917e-12, P_W_110 = 6.3951732798273e-10, 
       P_D_110 = -7.7786665997337e-12, U_P_110 = -8.92645957151217e-11, 
       U_W_110 = 4.31294999714282e-11, U_D_110 = 1.8864021456011e-11, 
       W_P_110 = 5.72303227031057e-09, W_U_110 = -1.03598463141452e-10, 
       W_D_110 = -2.40219266700592e-09, P_U_111 = 0, P_W_111 = 1.25565779995895e-10, 
       P_D_111 = 0, U_P_111 = 0, U_W_111 = 1.31841204620287e-11, U_D_111 = 0, 
       W_P_111 = 1.10708153755468e-09, W_U_111 = -2.52073917295093e-11, 
       W_D_111 = 5.06166397684638e-09, P = -0.737016398707797, U = 0.0133497700066894, 
       W = 1.76071901373649)
